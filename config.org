#+PROPERTY: header-args :results silent
#+begin_src emacs-lisp :tangle yes
;; -*- lexical-binding: t -*-
#+end_src

* Who am I?
#+begin_src emacs-lisp :tangle yes
;; Some functionality uses this to identify you, e.g. GPG configuration, email
;; clients, file templates and snippets.
(setq user-full-name "Francis Chan"
      user-mail-address "jackychany321@gmail.com")
#+end_src

* UI/Look
** Fonts
*** Default
#+begin_src emacs-lisp :tangle yes
;; Doom exposes five (optional) variables for controlling fonts in Doom. Here
;; are the three important ones:
;;
;; + `doom-font'
;; + `doom-variable-pitch-font'
;; + `doom-big-font' -- used for `doom-big-font-mode'; use this for
;;   presentations or streaming.
;;
;; They all accept either a font-spec, font string ("Input Mono-12"), or xlfd
;; font string. You generally only need these two:
;; (setq doom-font (font-spec :family "monospace" :size 12 :weight 'semi-light)
;;       doom-variable-pitch-font (font-spec :family "sans" :size 13))
(setq
 doom-font (font-spec :family "Sarasa Mono HC" :size 12)
 doom-variable-pitch-font (font-spec :family "Sarasa UI HC" :size 12))
#+end_src
*** Nerd
#+begin_src emacs-lisp :tangle yes
(after! nerd-icons (setq! nerd-icons-font-names '("SymbolsNerdFont-Regular.ttf")))
#+end_src

** Theme
#+begin_src emacs-lisp :tangle yes
;; There are two ways to load a theme. Both assume the theme is installed and
;; available. You can either set `doom-theme' or manually load a theme with the
;; `load-theme' function. This is the default:
(setq doom-theme 'doom-nord)
#+end_src

** No Dashboard Banner
#+begin_src elisp :tangle yes
(setq! +doom-dashboard-ascii-banner-fn #'(lambda ()))
(setq! +doom-dashboard-menu-sections '())
#+end_src
** hl-todo
#+begin_src emacs-lisp :tangle yes
;; TEMP keywords
(after! hl-todo (pushnew! hl-todo-keyword-faces '("TEMP" 'warning 'bold)))
#+end_src

** Pass
#+begin_src elisp :tangle yes
(after! pass (setq! pass-show-keybindings nil))
#+end_src
** No Which Key
#+begin_src emacs-lisp :tangle yes
(which-key-mode -1)
#+end_src
** Others
#+begin_src emacs-lisp :tangle yes
;; This determines the style of line numbers in effect. If set to `nil', line
;; numbers are disabled. For relative line numbers, set this to `relative'.
(setq display-line-numbers-type t)

;; Delete duplicated history
(setq history-delete-duplicates t)

;; fullscreen on startup
;; (add-to-list 'initial-frame-alist '(fullscreen . maximized))

;; tranparency NOTE It makes the text transparent too
;; (set-frame-parameter (selected-frame) 'alpha '(100 85))
;; (add-to-list 'default-frame-alist '(alpha 100 10))

(setq tab-width 4)

(setq! enable-local-variables t)

(setq! scroll-lock-mode t)
#+end_src
* Input
#+begin_src emacs-lisp :tangle yes
(setq! default-input-method "chinese-cns-tsangchi")
#+end_src
* Org Directory
#+begin_src emacs-lisp :tangle yes
;; If you use `org' and don't want your org files in the default location below,
;; change `org-directory'. It must be set before org loads!
(setq! org-directory "~/Documents/org")
#+end_src
* Scratch Buffer Use Org Mode
#+begin_src emacs-lisp :tangle yes
;; scratch buffer default `org-mode'
(setq! doom-scratch-initial-major-mode 'org-mode)
#+end_src
* Org
** Archive Location
#+begin_src emacs-lisp :tangle yes
(after! org (setq! org-archive-location "archive/%s_archive::"))
#+end_src
** Simple Org Configs
- ref :: https://explog.in/notes/writingsetup.html
#+begin_src emacs-lisp :tangle yes
(after! org
  (setq! org-hide-emphasis-markers t
         ;; org-adapt-indentation nil
         ;; org-indent-indentation-per-level 1
         org-complete-tags-always-offer-all-agenda-tags t
         org-log-into-drawer t
         org-log-reschedule "note"
         org-log-redeadline "note"
         org-id-locations-file (concat org-directory "/.orgids.gpg")))
#+end_src
** Priority
#+begin_src emacs-lisp :tangle yes
(after! org
  (setq! org-priority-default 67
         org-priority-lowest 69
         org-priority-faces '((65 . error)
                              (66 . warning)
                              (67 . warning)
                              (68 . success)
                              (69 . success))))
;; org-priority-faces
#+end_src

** Todo Keywords
*** Default
#+begin_src emacs-lisp :tangle yes
(after! org
  (setq! org-todo-keywords
         '((sequence "TODO(t)" "NEXT(n)" "PROJ(p)" "WAIT(w@)" "HOLD(h@)" "|" "DONE(d)" "KILL(k@)")
           (sequence "[ ](T)" "[?](W@)" "|" "[X](D)")
           (sequence "INBOX" "|" ))))
#+end_src
*** Faces
#+begin_src emacs-lisp :tangle yes
(after! org (pushnew! org-todo-keyword-faces '("INBOX" org-todo)))
#+end_src
** Agenda
*** fanshi/make-line
#+begin_src emacs-lisp :tangle yes
(defun fanshi/make-line () "" (concat "\n" (make-string (window-width) 9472)))
#+end_src

*** Org-Agenda
**** Clock
#+begin_src emacs-lisp :tangle yes
(after! org-agenda
  (setq! org-agenda-files '("~/Documents/org/gtd/")
   org-clock-report-include-clocking-task t
   org-agenda-clockreport-parameter-plist (quote (:link t :maxlevel 4 :fileskip0 t :compact t :narrow 80))
   org-agenda-start-with-log-mode t))
#+end_src

**** Agenda Tweak
#+begin_src emacs-lisp :tangle yes
(after! org-agenda
  (setq! org-agenda-block-separator 9472
         org-agenda-compact-blocks t
         org-agenda-breadcrumbs-separator " / "
         org-agenda-span 'day
         org-agenda-start-day nil
         org-agenda-start-on-weekday nil
         org-deadline-warning-days 30
         org-agenda-current-time-string "‚¨≤ NOW -- NOW --"
         org-agenda-prefix-format '(;; (agenda . " %-3i %18s  %?-12t %-25b ")
                                    ;; (agenda . " %-3i %-44b %?18s %?-12t")
                                    ;; (agenda . " %-3i %-44b %?-18s %?-12t")
                                    (agenda . " %-3i %-44b %11s %?-12t")
                                    ;; (todo . " %-3i                     ")
                                    (todo . " %-3i %-44b %?-12t")
                                    (tags . " %i %-12:c")
                                    (search . " %i %-12:c"))
         org-agenda-format-date (lambda (date) (concat (fanshi/make-line) "\n" (org-agenda-format-date-aligned date)))
         org-agenda-sorting-strategy '((agenda time-up habit-down priority-down category-keep)
                                      (todo priority-down category-keep)
                                      (tags priority-down category-keep)
                                      (search category-keep))
         org-agenda-skip-additional-timestamps-same-entry t))
#+end_src

**** Org Super Agenda
***** fanshi/agenda
#+begin_src emacs-lisp :tangle yes
(setq! fanshi/agenda
       '((:name "Clocked Today üì∞üì∞üì∞" :log t)
         ;; (:name "Calendar üìÖüìÖüìÖ" :time-grid t :and (:scheduled today :not (:habit t) ))
         (:name "Calendar üìÖüìÖüìÖ" :time-grid t :scheduled today)
         (:discard (:todo ("DONE"  "[X]")))
         (:name "Deadlines Just Aren't Real To Me Until I'm Staring One In The Face üö®üö®üö®" :deadline today :order 2)
         (:name "What Is Dead May Never Die üö£üö£üö£" :deadline past :order 3)
         (:name "Defuse The Bomb üí£üí£üí£" :deadline future :order 4)
         (:name "D√©j√† Vu üîÅüîÅüîÅ" :and (:habit t :todo ("TODO" "[ ]")) :order 5) ;; üßüüßüüßü
         ;; (:name "D√©j√† Vu üîÅüîÅüîÅ" :and (:habit t :todo ("TODO" "[ ]") :scheduled today) :order 5) ;; üßüüßüüßü
         ;; (:name "D√©j√† v√©cu ü•∂ü•∂ü•∂" :and (:habit t :todo ("TODO" "[ ]") :scheduled past) :order 6) ;; üßüüßüüßü
         ;; (:name "Presque vu ‚è©‚è©‚è©" :and (:habit t :todo ("TODO" "[ ]") :scheduled future) :order 7) ;; üßüüßüüßü
         ;; (:name "Meetings"
         ;;  :and (:todo "MEETING" :scheduled future)
         ;;  :order 8)
         ))
#+end_src
***** fanshi/alltodo
#+begin_src emacs-lisp :tangle yes
(after! (:and org org-gtd)
  (setq! fanshi/alltodo
         `((:discard (:scheduled t :deadline t :regexp ,org-scheduled-time-hour-regexp))
           (:name "Important üíéüíéüíé" :tag "Payment" :priority "A" :order 2) ;;üöîüöîüöî
           ;; (:name "Do I really look like a guy with a plan??? üÉèüÉèüÉè" :and (:todo "TOPLAN" :priority> "D") :order 3)
           (:name "Camping üèïüèïüèï" :todo "WAIT" :order 11) ; Set order of this section üíéüíéüíé
           ;; (:name "Peek Into Future üîÆüîÆüîÆ" :scheduled future :order 5)
           ;; (:name "Quick Picks üöÄüöÄüöÄ" :and (:effort< "0:15" :todo ("TODO" "[ ]")) :order 4)
           (:name "Next in line üöÄüöÄüöÄ" :and (:todo "NEXT") :order 4)
           (:discard (:and (:file-path ,org-gtd-default-file-name) ))
           ;; NOTE: tried to follow logic in org-habit-insert-consistency-graphs to find dying habit but seems not easy
           ;; (:name "Dying Habit" :and (:habit t
           ;;                      :todo ("TODO" "[ ]")
           ;;                      :not (:regexp ,org-scheduled-time-hour-regexp)) :order 5)))
           ;; (:name "D√©j√† Vu üîÅüîÅüîÅ" :and (:habit t
           ;;                               :todo ("TODO" "[ ]")
           ;;                               :scheduled t
           ;;                               :not (:scheduled future))
           ;;                :order 6)
           ;; (:name "Super B üë∂üë∂üë∂" :and (:priority "B" :not (:file-path "projects")) :order 6)
           ;; (:name "Optional üßßüßßüßß" :and (:file-path "tasks" :todo ("TODO" "[ ]") :priority "C") :order 8)
           ;; (:name "Others üèùüèùüèù" :and (:priority "C" :not (:file-path "projects")) :order 21)
           ;; (:name "Optional üßßüßßüßß" :and (:priority "C" :not (:file-path "projects")) :order 90)
           ;; NOTE: check
           ;; (:name "Should Be Nothing"
           ;;  :not (:file-path "projects"
           ;;        :file-path "read"
           ;;        )
           ;;  :order 99)
           ;; (:discard (:habit t))
           ;; NOTE Project
           ;; (:discard (:not (:file-path "projects")))
           (:auto-outline-path t  :order 7))))
#+end_src
***** fanshi/worktodo
#+begin_src emacs-lisp :tangle yes
(after! org
  (setq! fanshi/worktodo
         `((:discard (:scheduled t :deadline t :regexp ,org-scheduled-time-hour-regexp :not (:file-path "work")))
           (:auto-outline-path t  :order 7))))
#+end_src


***** fanshi/org-private-agenda-file-regexp (include GPG for private agenda)
[[https://emacs.stackexchange.com/a/36543][org mode - Include .org.gpg files in org-agenda - Emacs Stack Exchange]]
#+begin_src emacs-lisp :tangle yes
(setq! fanshi/org-private-agenda-file-regexp "\\`[^.].*\\.org\\\(\\.gpg\\\)?\\'")
#+end_src

***** Use Org Super Agenda
#+begin_src emacs-lisp :tangle yes
(use-package! org-super-agenda
  :after org-agenda
  :config
  (setq org-agenda-show-log t
        ;; NOTE: https://github.com/alphapapa/org-super-agenda/issues/50
        org-super-agenda-header-map (make-sparse-keymap)
        ;; fanshi/org-agenda-header (concat "\n" (make-string (window-width) 9472))
        ;; fanshi/make-org-agenda-header (defun () (concat "\n" (make-string (window-width) 9472)))
        org-agenda-custom-commands '(("p" "Private Agenda"
                                      ((agenda "" ((org-super-agenda-groups fanshi/agenda)
                                                   (org-agenda-file-regexp fanshi/org-private-agenda-file-regexp)))
                                       (alltodo "" ((org-agenda-overriding-header (fanshi/make-line))
                                                    (org-super-agenda-groups (cons `(:discard (:file-path ("work"))) fanshi/alltodo))
                                                    (org-agenda-file-regexp fanshi/org-private-agenda-file-regexp)))
                                       (alltodo "" ((org-agenda-overriding-header (fanshi/make-line))
                                                    (org-super-agenda-groups fanshi/worktodo)
                                                    (org-agenda-file-regexp fanshi/org-private-agenda-file-regexp)))
                                       ))
                                     ("w" "Work Agenda"
                                      ((agenda "" ((org-super-agenda-groups (cons `(:discard (:not (:file-path ("work")))) fanshi/agenda))
                                                   (org-agenda-file-regexp fanshi/org-private-agenda-file-regexp)))
                                       (alltodo "" ((org-agenda-overriding-header (fanshi/make-line))
                                                    (org-super-agenda-groups fanshi/worktodo)
                                                    (org-agenda-file-regexp fanshi/org-private-agenda-file-regexp)))))))
  :config
  (org-super-agenda-mode))
#+end_src

** Web Tool
#+begin_src emacs-lisp :tangle yes
(use-package! org-web-tools
  ;; :after-call org-capture
  :init (defun fanshi/org-web-tools--org-link-for-url ()
          (let* ((url (current-kill 0))
                 (html (org-web-tools--get-url url))
                 (title (org-web-tools--html-title html)))
            (if title (org-make-link-string url title)
              (message "HTML page at URL has no title") url)))
  :defer t
  :commands (org-web-tools--org-link-for-url))
#+end_src
** Journal
*** Encrypt
#+begin_src emacs-lisp :tangle yes
(after! org-journal (setq! org-journal-encrypt-journal t))
#+end_src
** GTD
*** Encryption Setup
#+begin_src emacs-lisp :tangle yes
(progn
  (setq! fanshi/org-private-agenda-file-regexp "\\`[^.].*\\.org\\\(\\.gpg\\\)?\\'")
  (setq! org-agenda-file-regexp fanshi/org-private-agenda-file-regexp))
#+end_src
*** fanshi/org-web-tools--org-link-for-url
#+begin_src emacs-lisp :tangle yes
(defun fanshi/org-web-tools--org-link-for-url ()
    (let* ((html (org-web-tools--get-url (current-kill 0)))
           (title (org-web-tools--html-title html)))
      (if title
          (org-make-link-string url title)
        (message "HTML page at URL has no title")
        url)))
#+end_src
*** Setup
#+begin_src emacs-lisp :tangle yes
(use-package! org-gtd
  :after org
  :init
  (setq! org-gtd-update-ack "3.0.0")
  :demand t
  :config
  (setq! org-gtd-directory (f-join org-directory "gtd")
         org-edna-use-inheritance t org-gtd-organize-hooks '(org-gtd-set-area-of-focus)
         org-gtd-archive-file-format "gtd_archive_%s.gpg"
         org-gtd-canceled "KILL"
         org-gtd-canceled-suffix "(k@)")
  (org-edna-mode)
  (advice-add #'org-gtd--path :filter-return (lambda (return-gtd-path) "gtd file path .gpg appended" (concat return-gtd-path ".gpg")))
  (setf (alist-get "l" org-gtd-capture-templates nil nil #'string=)
        `("link" entry (file ,(org-gtd-inbox-path)) ,(string-join '("* %(fanshi/org-web-tools--org-link-for-url)" "%U") "\n") :immediate-finish t))
  (map! :map doom-leader-map :desc "Org GTD Capture" "X" #'org-gtd-capture)
  (org-gtd-mode))
#+end_src
* Projectile
#+begin_src emacs-lisp :tangle yes
(after! projectile
  (setq projectile-project-name-function (lambda (project-root)
                                           (let ((name (funcall 'projectile-default-project-name project-root)))
                                             (if (member name '("python" "haskell" "bootstrap" "clojure"))
                                                 (concat (funcall 'projectile-default-project-name (file-name-directory (directory-file-name project-root))) "/" name)
                                               name))))
  ;; NOTE: higher priority for haskell-cabal (than the nix-flake) for projectile project detection
  (if-let ((cabal-project (cl-find-if (lambda (project-type-record) (string= (car project-type-record) 'haskell-cabal)) projectile-project-types)))
             (setq! projectile-project-types (cons cabal-project  projectile-project-types))))
#+end_src
* Clone projects
** clonable project configs
#+begin_src emacs-lisp :tangle yes
(setq fanshi/clonable-project-types `(nix-flake python-poetry clojure-cli haskell-cabal))
;; NOTE: What file to clone for specify project type
;; `generic', the default.
(setq fanshi/project-files-to-copy/generic '(".envrc" ".gitignore"
                                             ;; NOTE: copy the .direnv cache to speed up direnv for the first time
                                             ".direnv" ))
;; `nix'.
(setq fanshi/project-files-to-copy/nix-flake  (append fanshi/project-files-to-copy/generic '("flake.lock" "flake.nix")))
;; I am using the `nix' with `python' and `clojure'.
(setq fanshi/project-files-to-copy/python-poetry (append fanshi/project-files-to-copy/nix-flake '("poetry.lock" "pyproject.toml")))
(setq fanshi/project-files-to-copy/clojure-cli (append  fanshi/project-files-to-copy/nix-flake '("deps-lock.json" "deps.edn")))
;; using haskell.nix for 'haskell'
(setq fanshi/project-files-to-copy/haskell-cabal (append  fanshi/project-files-to-copy/nix-flake '("nix" "*.cabal" )))
#+end_src

** fanshi/init-new-project
#+begin_src emacs-lisp :tangle yes
(defun fanshi/init-new-project (&optional dir)
  "Init a directory as a new project"
  (interactive)
  (let ((default-directory (expand-file-name (or dir default-directory))))
    ;; NOTE: init git repo
    (require 'magit)
    (magit-call-git "init" (magit-convert-filename-for-git default-directory))

    ;; NOTE: init commit
    (magit-gitignore-in-gitdir "/.envrc")
    (magit-gitignore-in-gitdir "/.direnv/")
    (magit-stage-modified t)
    (magit-call-git "commit" '("-m" "init"))

    ;; NOTE: to load the .envrc
    (require 'envrc)
    (envrc-allow)
    (+vterm/toggle nil)))
#+end_src

** fanshi/clone-from-project
#+begin_src emacs-lisp :tangle yes
(defun fanshi/clone-from-project (dir)
  "Clone the infrastructure of an existing project DIR to make a new project"
  (require 'projectile)
  (if-let ((project-type (projectile-project-type dir))
           (project-files-to-copy (symbol-value (intern-soft (concat "fanshi/project-files-to-copy/" (prin1-to-string project-type)))))
           (new-project-directory (file-name-as-directory (read-directory-name "Create new project at directory: "))))
      (progn
        ;; NOTE: make new directory
        (make-directory new-project-directory t)
        ;; NOTE: copy files
        (dolist (wildcards-or-file project-files-to-copy)
          (dolist (file (projectile-verify-file-wildcard wildcards-or-file dir))
                  (dired-copy-file file new-project-directory 1)))
        ;; NOTE: init project
        (fanshi/init-new-project new-project-directory)
        ;; NOTE: switch to the new project
        (projectile-switch-project-by-name new-project-directory))
    (user-error (concat "Unsupported project type to clones: " (prin1-to-string project) " + " (prin1-to-string project-type) " + " (prin1-to-string project-files-to-copy)))))
#+end_src
** fanshi/choose-and-clone-for-new-project
#+begin_src emacs-lisp :tangle yes
(defun fanshi/choose-and-clone-for-new-project ()
  "To choose an existing porject, and clone the infrastructure of it to make a new project"
  (interactive )
  (require 'projectile)
  (if-let ((project-type (completing-read "Project type to clone: " fanshi/clonable-project-types))
           (projects (cl-remove-if (lambda (p) (progn (message p) (not (string-equal project-type (projectile-project-type p)))))
                                    projectile-known-projects)))
      (projectile-completing-read "Clone project: " projects :action #'fanshi/clone-from-project)
    (user-error "There are no clonable projects")))
#+end_src

* Langs
** Haskell
*** Template
#+begin_src emacs-lisp :tangle yes
(after! haskell-ts-mode (set-formatter! 'ormolu '("ormolu" filepath) :modes '(haskell-ts-mode)))
#+end_src

*** LSP
#+begin_src emacs-lisp :tangle no
(add-hook 'haskell-ts-mode-local-vars-hook #'lsp! 'append)
(after! lsp-haskell (setq! lsp-haskell-session-loading "multipleComponents"))
#+end_src
*** Eglot
**** fix elgot
- ref :: https://github.com/doomemacs/doomemacs/issues/8528#issuecomment-3386428778
#+begin_src emacs-lisp :tangle yes
(after! haskell-ts-mode (set-eglot-client! 'haskell-ts-mode '("haskell-language-server-wrapper" "--lsp" :initializationOptions '(:sessionLoading "multipleComponents")) "wtf is this"))
#+end_src
**** fix freeze 
- ref :: https://github.com/joaotavora/eglot/discussions/1151#discussioncomment-4689697
#+begin_src emacs-lisp :tangle no
(after! eglot
  (advice-add #'eglot--format-markup :around #'limit-argument-length)
  (defun limit-argument-length (orig input)
    "TEMP fix for eglot freeze with haskell-language-server"
    (let ((ty (plist-get input :kind))
          (v  (plist-get input :value)))
      (if (string= ty "markdown")
          (funcall orig (list :kind ty :value (seq-take v 700)))
        (funcall orig input)))))
#+end_src

*** Cabal
- ref :: https://github.com/doomemacs/doomemacs/issues/7762
#+begin_src emacs-lisp :tangle yes
(after! haskell-cabal (set-formatter! 'cabal-gild '("cabal-gild") :modes '(haskell-cabal-mode)))
#+end_src

*** Consult Hoogle
#+begin_src emacs-lisp :tangle yes
(use-package! consult-hoogle
  :defer t
  :config (advice-add #'consult-hoogle :around #'inheritenv-apply))
#+end_src
** Typescript
- ref :: https://www.reddit.com/r/emacs/comments/b7rsxu/behold_orgbabelexecutetypescript/
#+begin_src emacs-lisp :tangle yes
(defun org-babel-execute:typescript (body params)
  "babel execute typescript"
  (let* ((tmp-ts-file (org-babel-temp-file "scripts" ".ts"))
         (tmp-js-file (concat (substring tmp-ts-file 0 -2) "js"))
         (strict (if (assq :strict params) "--strict " ""))
         (target (if (assq :target params) (format " -t %s " (cdr (assq :target params))) ""))
         (cmd (concat "tsc " strict target (shell-quote-argument tmp-ts-file))))
    (with-temp-file tmp-ts-file (insert body))
    (with-temp-buffer
      (if (eq (call-process-shell-command cmd nil t) 0)
          (progn
            (insert-file-contents tmp-js-file)
            (if (assq :js params)
                (buffer-string)
              (require 'ob-js)
              (org-babel-execute:js (buffer-string) params)))
        (buffer-string)))))

;; NOTE when async
;; executing Typescript code block...
;; error in process sentinel: async-handle-result: Cannot open load file: No such file or directory, ob-typescript
;; maybe related? https://github.com/hlissner/doom-emacs/issues/2198
;; TEMP FIXME
(setq ob-async-no-async-languages-alist '("typescript"))
#+end_src
** Python
#+begin_src emacs-lisp :tangle yes
;; NOTE: https://github.com/abo-abo/lispy/issues/509
(after! (lispy python lpy)
  (add-hook 'lpy-mode-hook (lambda () (progn
                                   (setq-local python-shell-completion-native-disabled-interpreters (append python-shell-completion-native-disabled-interpreters '("python3")))
                                   (setq-local completion-at-point-functions '(lsp-completion-at-point python-completion-at-point t))
                                   (let ((lispy-python-proc-name (concat "lispy-python-" (projectile-project-name))))
                                     (condition-case nil
                                         (lispy--python-proc lispy-python-proc-name)
                                       (error (setq-local lispy-python-proc (get-process lispy-python-proc-name)))))
                                   (cl-letf (((symbol-function 'python-shell-send-string)
                                              (lambda (str process) (comint-send-string process (format "exec(%s)\n" (python-shell--encode-string str))))))
                                     (python-shell-send-string-no-output python-shell-eval-setup-code lispy-python-proc)
                                     (python-shell-send-string-no-output python-shell-eval-file-setup-code lispy-python-proc))
                                   (lispy-python-middleware-reload)))))
;; NOTE: https://github.com/abo-abo/lispy/issues/509
#+end_src
** Sql
#+begin_src emacs-lisp :tangle yes
(after! sql (set-formatter! 'pg_format "pg_format" :modes 'sql-mode))
#+end_src

** Astro
#+begin_src emacs-lisp :tangle no
(after! format-all
  (add-to-list 'auto-mode-alist '("\\.astro\\'" .
                                  (lambda ()
                                   (rjsx-mode)
                                   (lsp!)
                                   (setq-local +format-with-lsp nil
                                               +format-with 'prettier-astro
                                               ;; NOTE: class instead of className
                                               emmet-jsx-major-modes (remove 'rjsx-mode emmet-jsx-major-modes)))))
  (set-formatter! 'prettier-astro '("prettier" "--parser=astro" ("--plugin-search-dir=%s" (projectile-project-root))) :modes '((rxjs-mode ".astro")))
  ;; NOTE TEMP: https://github.com/doomemacs/doomemacs/issues/6936
  (puthash 'prettier-astro "prettier" format-all--executable-table))
#+end_src

** Lua
*** lsp
#+begin_src emacs-lisp :tangle no
(setq! lsp-clients-lua-language-server-command "lua-language-server")
(advice-add #'lsp-clients-lua-language-server-test :around (lambda (old &rest para) (or (executable-find lsp-clients-lua-language-server-command) (apply old para))))
#+end_src

** Fennel
*** lsp
#+begin_src emacs-lisp :tangle no
(after! lsp-mode
  (lsp-register-client
   (make-lsp-client :new-connection (lsp-stdio-connection "fennel-ls")
                    :activation-fn (lsp-activate-on "fennel")
                    :priority 1
                    :notification-handlers (ht ("fennel-ls/progressReport" #'ignore))
                    :server-id 'fennel-ls))
  (add-to-list 'lsp-language-id-configuration '(fennel-mode . "fennel")))
#+end_src
*** formatter
#+begin_src emacs-lisp :tangle yes
(after! fennel-mode (set-formatter! 'fnlfmt '("fnlfmt" filepath) :modes '(fennel-mode)))
#+end_src
* PDF View
#+begin_src emacs-lisp :tangle yes
(after! pdf-view
  (setq! pdf-tools-installer-os "nixos")
  (setq! pdf-view-midnight-colors '("#ABB2BF" . "#282C35"))
  (add-hook! pdf-tools-enabled #'pdf-view-midnight-minor-mode)
  ;; (add-hook! pdf-tools-enabled #'hide-mode-line-mode)
  )
#+end_src

* Vterm Use Fish
#+begin_src emacs-lisp :tangle yes
;; use 'vterm' with 'fish'
(after! vterm (setq! vterm-shell "fish"))
#+end_src
* Hledger
#+begin_src emacs-lisp :tangle no
(after! ledger-mode
  (setq!
   ledger-binary-path "hledger"
   ledger-init-file-name nil)
  ;; (rassq-delete-all '('ledger-mode) auto-mode-alist)
  ;; (add-to-list 'auto-mode-alist '("\\.\\(h?ledger\\|journal\\|j\\)$" . ledger-mode))
  )
#+end_src

* Not so long
** Problem
The so-long.el is for text files with long lines (think of e.g. minified JavaScript or CSS libs).
No point to enable it globally and moreover it broke some ux for me like the following:
#+begin_src emacs-lisp :tangle no
(helpful-callable #'org-toggle-link-display)
#+end_src
Because so-long-mode triggered on the source elisp file, the "coding: utf-8" local variable doesn't work and hence asking me for the coding system.
** So...
#+begin_src emacs-lisp :tangle yes
(global-so-long-mode -1)
#+end_src
* fanshi/ediff-init-and-example
- ref ::  https://github.com/doomemacs/doomemacs/issues/581#issuecomment-645448095
#+begin_src emacs-lisp :tangle yes
(defun fanshi/ediff-init-and-example ()
  "ediff the current `init.el' with the example in doom-emacs-dir"
  (interactive)
  (ediff-files (concat doom-private-dir "init.el")
               (concat doom-emacs-dir "static/init.example.el")))
(define-key! help-map
  "di"   #'fanshi/ediff-init-and-example
  )
#+end_src
* Plantuml
#+begin_src emacs-lisp :tangle yes
(after! plantuml-mode (setq! plantuml-default-exec-mode 'executable))
#+end_src

* Use Nov Mode
#+begin_src emacs-lisp :tangle yes
(use-package! nov
  :defer t
  :mode ((rx ".epub" eos) . nov-mode)
  :config (setq nov-save-place-file (concat doom-cache-dir "nov-places")))
#+end_src

* envrc
#+begin_src emacs-lisp :tangle yes
(defun fanshi/envrc-update ()
  "just update the current env with the cache."
  (interactive)
  (envrc--with-required-current-env env-dir (envrc--update-env env-dir)))
#+end_src

* spell fu dicts
#+begin_src emacs-lisp :tangle no
;; FIXME
(after! spell-fu
  (setq! ispell-dictionary "en")
  (spell-fu-dictionary-add (spell-fu-get-ispell-dictionary "en")))
#+end_src

* jinx
- copied from :: https://github.com/doomemacs/doomemacs/issues/7617#issuecomment-1952479210
#+begin_src emacs-lisp :tangle yes
(use-package! jinx
  :hook (emacs-startup . global-jinx-mode)
  :bind (("M-$" . jinx-correct))
  :config (progn
            (setq! jinx-languages "en_US"
                   jinx-delay 1.0)
            (after! vertico-multiform
              (add-to-list 'vertico-multiform-categories
                           '(jinx (vertico-grid-annotate . 25))))))
#+end_src
* I like to abuse writeroom
#+begin_src emacs-lisp :tangle yes
(after! writeroom-mode
  (setq! writeroom-maximize-window t
         writeroom-major-modes '(text-mode org-mode prog-mode))
  (pushnew! +zen-mixed-pitch-modes 'prog-mode))
(global-writeroom-mode)
#+end_src

* Gptel
** Default
#+begin_src emacs-lisp :tangle yes
(after! gptel
  (setq!
   gptel-display-buffer-action t
   gptel-default-mode 'org-mode
   gptel-highlight-methods '(margin face)
   gptel-backend (gptel-make-gh-copilot)
   gptel-log-level :info)
  (pushnew! gptel-directives '(full1 . "Please think harder to give your highest quality answer.
    We pursue depth, not superficial breadth;
    we pursue essential insight, not a list of appearances;
    we pursue innovation in thinking, not habitual reiteration.
    Think critically! Think creatively!
    Please show us your cognitive limits."))
  (setcdr (assq 'org-mode gptel-prompt-prefix-alist) "* ")
  (gptel-highlight-mode t))
#+end_src
** Gemini
#+begin_src emacs-lisp :tangle no
(after! gptel
  (setq!
   gptel-model 'gemini-flash-lit
   gptel-backend (gptel-make-gemini "Gemini"
                   :key #'gptel-api-key-from-auth-source
                   :models (cl-map 'list (lambda (model) (assq model gptel--gemini-models))
                                   '(gemini-flash-lite-latest
                                     gemini-flash-latest
                                     gemini-2.5-flash-lite))
                   ;; :request-params '(:tools [(:google_search ()) (:url_context ())])
                   :stream t))
  (gptel-make-preset 'default :model 'gemini-flash-latest :backend "Gemini" :request-params
                     '(:tools [(:google_search ()) (:url_context ())]))
  (gptel-make-preset 'full :parents 'default :system 'full)
  (gptel-make-preset 'google-map
    :system "Your job is to complete tasks given by leveraging Google Maps to provide factually accurate and fresh information that are relevant to specified locations or general area."
    :model 'gemini-2.5-flash-lite
    :request-params '(:tools [(:googleMaps ())]
                      ;; :toolConfig (:retrievalConfig (:latLng (:latitude 34.050481 :longitude
                      ;; -118.2))
                      )))
#+end_src
** TEMP fix for gptel-send with active regoin under org-mode
gptel--insert-response use org-cycle to hide some block in response which in turn trigger +org-yas-expand-maybe-h unexpectedly
#+begin_src emacs-lisp :tangle yes
(advice-add #'gptel-send :after (lambda (&rest r) "call `deactivate-mark' after, to temp fix an unexpected trigger of snippet by org-cycle calls in reponse" (if (use-region-p) (deactivate-mark))))
#+end_src
** Agent
#+begin_src emacs-lisp :tangle yes
(use-package! gptel-agent
  :after gptel
  :config (->>
           "/introspector.md"
           (concat (car gptel-agent-dirs))
           gptel-agent-read-file
           cdr
           (apply #'gptel-make-preset 'introspector)))
#+end_src
** Preset for Gemini Builtin Tools
- [[https://github.com/google/adk-docs/tree/82e9fa553fc42d0ddc8ebca9b0b0ed17b1621fa3/docs/tools/built-in-tools.md#limitations][gemini tool limitations]]
- [[file:~/.emacs.d/.local/straight/repos/gptel-agent/gptel-agent-tools.el::(gptel-make-tool][adapted from tool Agent]]
#+begin_src emacs-lisp :tangle no
(after! gptel
  (defun fanshi/make-gemini-preset-tool (name &rest keys)
    "Define a gptel agent and make a tool out of it.
NAME and KEYS will be passed to `gptel-make-preset' to make a preset (as agent) first.
Then we make a tool (with tool name: NAME) out of it,
which could be called by other gptel agents when listed in its :tools, for example:

  (`gptel-make-preset' \\='call_agent
    :tools  \\='(\"NAME\"))
"
    (apply #'gptel-make-preset name (plist-put keys :backend "Gemini"))
    (if-let* ((agent-name (symbol-name name))
              (preset (cdr (assq name gptel--known-presets)))
              (system (plist-get :system preset)))
        (gptel-make-tool
         :name agent-name
         :description (concat "Use this to delegate a task to a agent,\
who tackle the task independently with their speciality and return results in one message.\
Here is the description of the job duty of the agent:\
\
" system)
         :function (-cut gptel-agent--task <> agent <> <>)
         :args '((:name "description"
                  :type "string"
                  :description "A short (3-5 word) description of the task")
                 (:name "prompt"
                  :type "string"
                  :description "The detailed task for the agent to perform autonomously.\
Should include exactly what information the agent should return."))
         :category "gemini-builtin-tools"
         :async t
         :confirm t
         :include t)
      (message (format "fanshi/make-gemini-preset-tool failed, agent-name:(%s) , preset:(%s), system:(%s)" agent-name preset system))))
  (fanshi/make-gemini-preset-tool 'google-search
                                  :system "Your job is to complete tasks given by gathering up-to-date information from the web via google search")
  (fanshi/make-gemini-preset-tool 'google-map
                                  :system "Your job is to complete tasks given by leveraging Google Maps to provide factually accurate and fresh information that are relevant to specified locations or general area."
                                  :model        'gemini-2.5-flash-lite
                                  :request-params '(:tools [(:googleMaps ())]
                                                    ;; :toolConfig (:retrievalConfig (:latLng (:latitude 34.050481 :longitude -118.2))
                                                    ))
  (fanshi/make-gemini-preset-tool 'python-specialist
                                  :system  "Your job is to complete tasks given by writing and execute Python code iteratively until it arrives at a final output. \
You can only able to execute code in Python, but you can still generate code in another language without running them."
                                  :model        'gemini-flash-latest
                                  :request-params '(:tools [(:code_execution ())])))
#+end_src
** Youtube links
*** fanshi/youtube-link-regexp
#+begin_src emacs-lisp :tangle yes
;; The whole match (group 0) will be the full URL
(setq! fanshi/youtube-link-regexp
       (rx (group
            (optional "http" (optional "s") "://")
            (or
             ;; Short youtu.be/
             (seq (optional "www.")
                  "youtube.com/" (or
                                  ;; Standard youtube.com/watch
                                  "watch?v="
                                  ;; youtube.com/shorts/ or /embed/
                                  "shorts/"
                                  "embed/"))
             "youtu.be/")
            (1+ (or alnum "-_" "%")) ;; Video ID: 11 characters (alphanumeric, hyphen, underscore)
            (*? (not space))))) ;; 6. Remaining URL part: captures query parameters like &list=
#+end_src

*** fanshi/extract-youtube-links
#+begin_src emacs-lisp :tangle yes
(defun fanshi/extract-youtube-links (string)
  "Extract all YouTube URLs from STRING.

Returns a list of all matched YouTube links. Handles standard
watch links and short youtu.be links. The links are returned
in the order they appear in the string.
"
  (cl-loop with start = 0
           while (string-match fanshi/youtube-link-regexp string start)
           do
           (setq start (match-end 0))
           collect (match-string 0 string)))
#+end_src

*** Test case
#+begin_src elisp :tangle no :results value replace
;; Define a test string with multiple YouTube URLs
(let ((test-string
       "Check out this video: https://www.youtube.com/watch?v=dQw4w9WgXcQ&list=RDB_4T0-7fG50
Also the short link: https://youtu.be/kU9ZcO4w38o and a standard one http://youtube.com/watch?v=zT6_V_G_O3c.
This is text in between."))

  ;; Call the function
  (fanshi/extract-youtube-links test-string))
#+end_src

#+RESULTS:
| https://www.youtube.com/watch?v=dQw4w9WgXcQ | https://youtu.be/kU9ZcO4w38o | http://youtube.com/watch?v=zT6 |
** TEMP FIXME for straight warnings
#+begin_example
‚õî Warning (straight): package.el was loaded when straight.el was already loaded. You may wish to delete ~/.emacs.d/elpa or add (setq package-enable-at-startup nil) to ~/.emacs.d/early-init.el to avoid multiple versions of the same packages being loaded.
#+end_example
- REF :: https://github.com/antonalekseev/dotfiles/commit/741c60eccd1d23cff6e38c14ba254b2bb927d7e1
#+begin_src emacs-lisp :tangle yes
(setq straight-package--warning-displayed t)
#+end_src
* Latex setup for Altacv
#+begin_src emacs-lisp :tangle yes
(after! org
  (use-package! ox-extra
    :config
    (ox-extras-activate '(latex-header-blocks ignore-headlines))
    (setq org-latex-hyperref-template nil) ;; stop org adding hypersetup{author..} to latex export
    (add-to-list 'org-latex-classes
                 '("altacv"
                   "\\documentclass[10pt,a4paper,ragged2e,withhyper]{altacv}"
                   ("\\cvsection{%s}" . "\\cvsection*{%s}")
                   ("\\cvevent{%s}" . "\\cvevent*{%s}")))
    ))
#+end_src
* Custom
#+begin_src emacs-lisp :tangle yes
;; Here are some additional functions/macros that could help you configure Doom:
;;
;; - `load!' for loading external *.el files relative to this one
;; - `use-package!' for configuring packages
;; - `after!' for running code after a package has loaded
;; - `add-load-path!' for adding directories to the `load-path', relative to
;;   this file. Emacs searches the `load-path' when you load packages with
;;   `require' or `use-package'.
;; - `map!' for binding new keys
;;
;; To get information about any of these functions/macros, move the cursor over
;; the highlighted symbol at press 'K' (non-evil users must press 'C-c c k').
;; This will open documentation for it, including demos of how they are used.
;;
;; You can also try 'gd' (or 'C-c c d') to jump to their definition and see how
;; they are implemented.
(custom-set-variables
 ;; custom-set-variables was added by Custom.
 ;; If you edit it by hand, you could mess it up, so be careful.
 ;; Your init file should contain only one such instance.
 ;; If there is more than one, they won't work right.
 )
(custom-set-faces
 ;; custom-set-faces was added by Custom.
 ;; If you edit it by hand, you could mess it up, so be careful.
 ;; Your init file should contain only one such instance.
 ;; If there is more than one, they won't work right.
 )
#+end_src
